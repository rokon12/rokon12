<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="canonical" href="https://bazlur.ca/2023/08/30/writing-testable-code-a-journey-through-consideration-and-refactoring/"><title>Writing Testable Code: A Journey Through Consideration and Refactoring | Bazlur’s Blog Archive</title><meta name="generator" content="Jekyll v3.9.5" /><meta property="og:title" content="Writing Testable Code: A Journey Through Consideration and Refactoring" /><meta name="author" content="A N M Bazlur Rahman" /><meta property="og:locale" content="en_US" /><meta name="description" content="A comprehensive archive of articles on Java, Software Development, and Technology" /><meta property="og:description" content="A comprehensive archive of articles on Java, Software Development, and Technology" /><link rel="canonical" href="http://localhost:4000/backup/writing-testable-code-a-journey-through-consideration-and-refactoring.html" /><meta property="og:url" content="http://localhost:4000/backup/writing-testable-code-a-journey-through-consideration-and-refactoring.html" /><meta property="og:site_name" content="Bazlur’s Blog Archive" /><meta property="og:image" content="http://localhost:4000/assets/img/default-og.jpg" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:image" content="http://localhost:4000/assets/img/default-og.jpg" /><meta property="twitter:title" content="Writing Testable Code: A Journey Through Consideration and Refactoring" /><meta name="twitter:site" content="@bazlur_rahman" /><meta name="twitter:creator" content="@A N M Bazlur Rahman" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"A N M Bazlur Rahman","url":"https://bazlur.ca"},"description":"A comprehensive archive of articles on Java, Software Development, and Technology","headline":"Writing Testable Code: A Journey Through Consideration and Refactoring","image":"http://localhost:4000/assets/img/default-og.jpg","url":"http://localhost:4000/backup/writing-testable-code-a-journey-through-consideration-and-refactoring.html"}</script><style> /* Critical CSS - Inline for faster initial render */ :root { --primary-color: #2563eb; --secondary-color: #7c3aed; --text-color: #1f2937; --text-light: #6b7280; --bg-color: #ffffff; --bg-gray: #f9fafb; } * { margin: 0; padding: 0; box-sizing: border-box; } body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; line-height: 1.6; color: var(--text-color); background: var(--bg-gray); } .wrapper { max-width: 1200px; margin: 0 auto; padding: 0 2rem; } header { background: var(--bg-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; } .site-nav { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; } .site-title { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); text-decoration: none; } .nav-links { display: flex; gap: 2rem; list-style: none; } .nav-links a { color: var(--text-color); text-decoration: none; transition: color 0.2s; } .nav-links a:hover { color: var(--primary-color); } /* Above-the-fold home page styles */ .banner-container { margin: 2rem auto 3rem; text-align: center; } .ascii-banner { display: inline-block; font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.2; color: var(--primary-color); } @media (max-width: 768px) { .wrapper { padding: 0 1rem; } .ascii-banner { font-size: 6px; } .nav-links { gap: 1rem; } }</style><link rel="preload" href="/assets/css/main.css?v=2" as="style" onload="this.onload=null;this.rel='stylesheet'"> <noscript><link rel="stylesheet" href="/assets/css/main.css?v=2"></noscript><link rel="alternate" type="application/rss+xml" title="Bazlur&#39;s Blog Archive" href="/feed.xml"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://cdnjs.cloudflare.com"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet"><body><header class="site-header"><div class="header-wrapper"> <a class="site-title" href="/">Bazlur&#39;s Blog Archive</a> <button class="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false"> <span class="hamburger"> <span></span> <span></span> <span></span> </span> </button><nav class="site-nav"> <a class="nav-link" href="/">Home</a> <a class="nav-link" href="/archive">Archive</a> <a class="nav-link" href="/tags">Tags</a> <a class="nav-link" href="/search">Search</a> <a class="nav-link" href="https://bazlur.com/conference/" target="_blank" rel="noopener">Speaking</a> <a class="nav-link" href="/about">About</a> <a class="nav-link nav-link-external" href="https://bazlur.ca" target="_blank" rel="noopener">Original Site →</a></nav></div></header><main class="page-content" aria-label="Content"><p><img src="/backup/images/8a588ade-2fff-41d7-9407-1b10f524271d.jpeg" alt="" /></p><h1 id="writing-testable-code-a-journey-through-consideration-and-refactoring">Writing Testable Code: A Journey Through Consideration and Refactoring</h1><p><strong>In an ideal world, every piece of code we write would be easily testable, clearly understood, and perfectly maintainable. However, reality often presents us with complex problems and solutions that aren’t always straightforward. Writing testable code sometimes requires a thoughtful approach, deep consideration of the use cases, and even refactoring to ensure that the code is robust and fully tested.</strong></p><h2 id="the-challenge-of-testing">The Challenge of Testing</h2><p>Imagine a scenario where you need to create an Amazon S3 client based on different credential providers. At first glance, the implementation might seem simple. However, when it comes to writing unit tests for this code, challenges arise.</p><p>The initial implementation might include a method that builds the S3 client, choosing between different credentials providers based on the input parameters. While this code may function correctly, testing it becomes a problem. How do you verify which credentials provider was used? How do you isolate the code from the AWS SDK, which might require real AWS credentials?</p><p>Let’s see an example:</p><pre><code>public AmazonS3 getAmazonS3Client(
        final String s3AccessKeyId, final String secretAccessKey, final Regions region) {
    final AWSCredentialsProvider credentialsProvider;
    if (StringUtils.isNotEmpty(s3AccessKeyId) &amp;&amp; StringUtils.isNotEmpty(secretAccessKey)) {
        credentialsProvider =
                new AWSStaticCredentialsProvider(new BasicAWSCredentials(s3AccessKeyId, secretAccessKey));
    } else {
        credentialsProvider = new DefaultAWSCredentialsProviderChain();
    }

    return AmazonS3ClientBuilder.standard()
            .withCredentials(credentialsProvider)
            .withRegion(region)
            .build();
}
</code></pre><h2 id="the-process-of-refactoring">The Process of Refactoring</h2><p>Recognizing that the code is hard to test, the next step is to consider how it can be refactored to make testing easier. This often involves identifying the dependencies and behaviours that are hard to test and finding ways to isolate them.</p><p>In our example, the challenge was verifying the code’s behaviour based on different credentials providers.</p><p>The solution can be by introducing an interface and separate implementations for the different scenarios. This allowed the behaviour to be tested in isolation without having to know the internal details of the Amazon S3 client.</p><p>This refactoring process involved several steps:</p><ul><li><strong>Identifying the Problem:</strong> Recognizing that the code was hard to test and understanding why.<li><strong>Designing a Solution:</strong> Introducing an interface and separate implementations to isolate the behaviour.<li><strong>Implementing the Changes:</strong> Refactoring the code to use the new design.<li><strong>Writing the Tests:</strong> Creating unit tests that cover all code paths and may ensure 100% coverage.</ul><p>Here’s the refactored code:</p><pre><code>interface AmazonS3ClientFactory {
    AmazonS3 getAmazonS3Client(String s3AccessKeyId, String secretAccessKey, Regions region);
}

static class AWSStaticCredentialsProviderS3ClientFactory implements AmazonS3ClientFactory {
    @Override
    public AmazonS3 getAmazonS3Client(String s3AccessKeyId, String secretAccessKey, Regions region) {
        return AmazonS3ClientBuilder.standard()
                .withCredentials(new AWSStaticCredentialsProvider(new BasicAWSCredentials(s3AccessKeyId, secretAccessKey)))
                .withRegion(region)
                .build();
    }
}

static class DefaultAWSCredentialsProviderChainS3ClientFactory implements AmazonS3ClientFactory {
    @Override
    public AmazonS3 getAmazonS3Client(String s3AccessKeyId, String secretAccessKey, Regions region) {
        return AmazonS3ClientBuilder.standard()
                .withCredentials(new DefaultAWSCredentialsProviderChain())
                .withRegion(region)
                .build();
    }
}


AmazonS3 getAmazonS3Client(
        final String s3AccessKeyId, final String secretAccessKey, final Regions region) {
    if (StringUtils.isNotEmpty(s3AccessKeyId) &amp;&amp; StringUtils.isNotEmpty(secretAccessKey)) {
        return new AWSStaticCredentialsProviderS3ClientFactory().getAmazonS3Client(s3AccessKeyId, secretAccessKey, region);
    } else {
        return new DefaultAWSCredentialsProviderChainS3ClientFactory().getAmazonS3Client(s3AccessKeyId, secretAccessKey, region);
    }
}
</code></pre><p>This refactoring allowed the behaviour to be tested in isolation without having to know the internal details of the Amazon S3 client.</p><h2 id="writing-the-tests">Writing the Tests</h2><p>With the code refactored, we can now write unit tests that cover all code paths and ensure 100% coverage. Here are the specific tests:</p><h3 id="test-the-aws-static-credentials-provider-factory">Test the AWS Static Credentials Provider Factory</h3><p>This test ensures that the factory for creating an S3 client with static credentials works correctly.</p><pre><code>@Test
public void shouldUseAWSStaticCredentialsProvider_whenKeysProvided() {
  var factory = new AgentAttackEventS3Operations.AWSStaticCredentialsProviderS3ClientFactory();
  AmazonS3 s3Client = factory.getAmazonS3Client(S3_ACCESS_KEY_ID, S3_SECRET_ACCESS_KEY, REGION);
  assertThat(s3Client).isNotNull();
  assertEquals(REGION.getName(), s3Client.getRegionName());
}
</code></pre><h3 id="test-the-default-aws-credentials-provider-factory">Test the Default AWS Credentials Provider Factory</h3><p>This test ensures that the factory for creating an S3 client with the default credentials provider works correctly.</p><pre><code>@Test
public void shouldUseDefaultAWSCredentialsProvider_whenKeysNotProvided() {
  var factory =
      new AgentAttackEventS3Operations.DefaultAWSCredentialsProviderChainS3ClientFactory();
  AmazonS3 s3Client = factory.getAmazonS3Client(S3_ACCESS_KEY_ID, S3_SECRET_ACCESS_KEY, REGION);
  assertThat(s3Client).isNotNull();
  assertEquals(REGION.getName(), s3Client.getRegionName());
}
</code></pre><h3 id="test-the-choice-of-credentials-provider-based-on-input">Test the Choice of Credentials Provider Based on Input</h3><p>These tests ensure that the correct factory is used based on the presence or absence of access keys.</p><pre><code>@Test
public void shouldUseAWSStaticCredentials_whenKeysNotEmpty() {
  s3Operations.getAmazonS3Client(S3_ACCESS_KEY_ID, S3_SECRET_ACCESS_KEY, REGION);

  verify(awsStaticCredentialsProviderS3ClientFactory, times(1))
      .getAmazonS3Client(anyString(), anyString(), any(Regions.class));
  verify(defaultAWSCredentialsProviderChainS3ClientFactory, times(0))
      .getAmazonS3Client(anyString(), anyString(), any(Regions.class));
}

@Test
public void shouldUseDefaultAWSCredentials_whenKeysEmpty() {
  s3Operations.getAmazonS3Client("", "", REGION);

  verify(awsStaticCredentialsProviderS3ClientFactory, times(0))
      .getAmazonS3Client(anyString(), anyString(), any(Regions.class));
  verify(defaultAWSCredentialsProviderChainS3ClientFactory, times(1))
      .getAmazonS3Client(anyString(), anyString(), any(Regions.class));
}
</code></pre><p>These examples illustrate how refactoring the code to use an interface and separate implementations allows for thorough testing of the logic, including the choice of credentials provider based on the input parameters.</p><h2 id="lessons-learned-and-conclusion">Lessons Learned and Conclusion</h2><p>The journey from initial implementation to fully testable code teaches us to:</p><ul><li><strong>Consider Testability from the Start</strong><li><strong>Don’t Be Afraid to Refactor</strong><li><strong>Use Tools Wisely</strong><li><strong>Test Behavior, Not Implementation</strong></ul><p>In the end, the journey toward testable code is one of continuous learning and improvement.</p><p>It’s a path that leads to better code, better tests, and better software.</p><p>By considering real-world examples and learning from the process of refactoring and testing, we can create robust and maintainable code that stands the test of time.</p><hr /><h3 id="discover-more-from-a-n-m-bazlur-rahman">Discover more from A N M Bazlur Rahman</h3><p>Subscribe to get the latest posts sent to your email.<br /> Type your email… {#subscribe-email}</p><p>Subscribe {#subscribe-submit}</p></main><footer class="site-footer"><div class="footer-content"><p>A comprehensive archive of articles on Java, Software Development, and Technology</p><p>© 2025 A N M Bazlur Rahman. All articles are archived from <a href="https://bazlur.ca">bazlur.ca</a></p><p> <a href="/feed.xml">RSS Feed</a> • <a href="https://twitter.com/bazlur_rahman">Twitter</a> • <a href="https://github.com/rokon12">GitHub</a></p></div></footer><script> // Fade-in animations on scroll document.addEventListener('DOMContentLoaded', function() { const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -100px 0px' }; const observer = new IntersectionObserver(function(entries) { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('visible'); observer.unobserve(entry.target); } }); }, observerOptions); // Observe fade-in elements document.querySelectorAll('.fade-in, .fade-in-up, .fade-in-left, .fade-in-right, .stagger-animation').forEach(el => { observer.observe(el); }); // Add fade-in classes to post cards document.querySelectorAll('.post-card').forEach((card, index) => { card.classList.add('fade-in-up'); card.style.transitionDelay = `${index * 0.1}s`; }); // Removed duplicate image observer - handled by image-optimization.js }); </script> <script defer src="/assets/js/terminal.js"></script> <script defer src="/assets/js/image-optimization.js"></script> <script> if ('loading' in HTMLImageElement.prototype) { const images = document.querySelectorAll('img[loading="lazy"]'); images.forEach(img => { img.src = img.dataset.src || img.src; }); } else { // Fallback for browsers that don't support lazy loading const script = document.createElement('script'); script.src = 'https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js'; document.body.appendChild(script); } </script> <script> document.addEventListener('DOMContentLoaded', function() { // Mobile menu toggle const mobileMenuToggle = document.querySelector('.mobile-menu-toggle'); const siteNav = document.querySelector('.site-nav'); if (mobileMenuToggle) { mobileMenuToggle.addEventListener('click', function() { const isExpanded = this.getAttribute('aria-expanded') === 'true'; this.setAttribute('aria-expanded', !isExpanded); siteNav.classList.toggle('is-active'); document.body.classList.toggle('menu-open'); }); // Close menu when clicking outside document.addEventListener('click', function(e) { if (!e.target.closest('.site-header') && siteNav.classList.contains('is-active')) { mobileMenuToggle.setAttribute('aria-expanded', 'false'); siteNav.classList.remove('is-active'); document.body.classList.remove('menu-open'); } }); } // Initialize theme const savedTheme = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', savedTheme); // Global search shortcut document.addEventListener('keydown', function(e) { // Focus search with / if (e.key === '/' && !e.metaKey && !e.ctrlKey) { const searchInput = document.querySelector('.quick-search-input') || document.querySelector('#search-input'); if (searchInput && document.activeElement !== searchInput) { e.preventDefault(); searchInput.focus(); document.body.classList.add('search-focused'); } } // Clear focus on ESC if (e.key === 'Escape') { const searchInput = document.querySelector('.quick-search-input') || document.querySelector('#search-input'); if (searchInput && document.activeElement === searchInput) { searchInput.blur(); searchInput.value = ''; document.body.classList.remove('search-focused'); } } }); }); </script> <button class="back-to-top" id="back-to-top" aria-label="Back to top"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline> </svg> </button> <script> document.addEventListener('DOMContentLoaded', function() { const backToTopButton = document.getElementById('back-to-top'); // Show/hide button based on scroll position function toggleBackToTop() { if (window.scrollY > 300) { backToTopButton.classList.add('visible'); } else { backToTopButton.classList.remove('visible'); } } // Throttle scroll events let isScrolling = false; window.addEventListener('scroll', function() { if (!isScrolling) { window.requestAnimationFrame(function() { toggleBackToTop(); isScrolling = false; }); isScrolling = true; } }); // Smooth scroll to top backToTopButton.addEventListener('click', function() { window.scrollTo({ top: 0, behavior: 'smooth' }); }); // Initial check toggleBackToTop(); }); </script> <script> if ('serviceWorker' in navigator) { window.addEventListener('load', function() { navigator.serviceWorker.register('/sw.js').then(function(registration) { console.log('ServiceWorker registration successful'); }, function(err) { console.log('ServiceWorker registration failed: ', err); }); }); } </script>